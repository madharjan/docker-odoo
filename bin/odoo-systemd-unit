#!/bin/sh

set e

if [ "${DEBUG}" = true ]; then
  set -x
fi

DEF_PORT=8080
DEF_VOLUME_HOME=${VOLUME_HOME}
DEF_VERSION=12.0

DEF_ODOO_DATABASE_NAME=Demo
DEF_ODOO_ADMIN_PASSWORD=Pa55w0rd
DEF_ODOO_ADMIN_EMAIL=root@localhost.localdomain
DEF_ODOO_COMPANY=Acme Pte Ltd
DEF_ODOO_INSTALL_MODULES=website
DEF_ODOO_UNINSTALL_MODULES=
DEF_ODOO_LANG=en_US

DEF_POSGRESQL_DATABASE=postgresql

PORT=${PORT:-$DEF_PORT}
VOLUME_HOME=${VOLUME_HOME:-$DEF_VOLUME_HOME}
VERSION=${VERSION:-$DEF_VERSION}

ODOO_DATABASE_NAME=${ODOO_DATABASE_NAME:-$DEF_ODOO_DATABASE_NAME}
ODOO_ADMIN_PASSWORD=${ODOO_ADMIN_PASSWORD:-$DEF_ODOO_ADMIN_PASSWORD}
ODOO_ADMIN_EMAIL=${ODOO_ADMIN_EMAIL:-$DEF_ODOO_ADMIN_EMAIL}
ODOO_COMPANY=${ODOO_COMPANY:-$DEF_ODOO_COMPANY}
ODOO_INSTALL_MODULES=${ODOO_INSTALL_MODULES:-$DEF_ODOO_INSTALL_MODULES}
ODOO_UNINSTALL_MODULES=${ODOO_UNINSTALL_MODULES:-$DEF_ODOO_UNINSTALL_MODULES}
ODOO_LANG=${ODOO_LANG:-DEF_ODOO_LANG}

POSGRESQL_DATABASE=${POSGRESQL_DATABASE:-DEF_POSGRESQL_DATABASE}

/bin/cat <<-EOF
[Unit]
Description=Odoo Server

After=docker.service

[Service]
TimeoutStartSec=0

ExecStartPre=-/bin/mkdir -p ${VOLUME_HOME}/odoo/etc
ExecStartPre=-/bin/mkdir -p ${VOLUME_HOME}/odoo/addons
ExecStartPre=-/bin/mkdir -p ${VOLUME_HOME}/odoo/lib
ExecStartPre=-/bin/mkdir -p ${VOLUME_HOME}/odoo/log
ExecStartPre=-/usr/bin/docker stop odoo
ExecStartPre=-/usr/bin/docker rm odoo
ExecStartPre=-/usr/bin/docker pull madharjan/docker-odoo:${VERSION}

ExecStart=/usr/bin/docker run \\
  --link ${POSGRESQL_DATABASE}:postgresql \\
  -e ODOO_DATABASE_NAME=${ODOO_DATABASE_NAME} \\
  -e ODOO_ADMIN_PASSWORD=${ODOO_ADMIN_PASSWORD} \\
  -e ODOO_ADMIN_EMAIL=${ODOO_ADMIN_EMAIL} \\
  -e ODOO_COMPANY="${ODOO_COMPANY}" \\
  -e ODOO_INSTALL_MODULES="${ODOO_INSTALL_MODULES}" \\
  -e ODOO_UNINSTALL_MODULES="${ODOO_UNINSTALL_MODULES}" \\
  -e ODOO_LANG=${ODOO_LANG} \\
  -p ${PORT}:8069 \\
  -v ${VOLUME_HOME}/odoo/etc:/etc/odoo \\
  -v ${VOLUME_HOME}/odoo/addons:/opt/odoo/extra \\
  -v ${VOLUME_HOME}/odoo/lib:/var/lib/odoo \\
  -v ${VOLUME_HOME}/odoo/log:/var/log/odoo \\
  --name odoo \\
  madharjan/docker-odoo:${VERSION}

ExecStop=/usr/bin/docker stop -t 2 odoo

[Install]
WantedBy=multi-user.target
EOF